<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>AR Проект</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #000;
        }
        
        /* Сцены */
        .scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        
        #start-scene {
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .start-content {
            text-align: center;
            padding: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        p {
            color: #666;
            margin-bottom: 30px;
        }
        
        /* Кнопки */
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        
        #back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #FF3B30;
            z-index: 10000;
        }
        
        /* Видео поток для отладки */
        #videoDebug {
            position: fixed;
            top: 0;
            left: 0;
            width: 200px;
            height: 150px;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Начальная сцена -->
    <div id="start-scene" class="scene">
        <div class="start-content">
            <h1>AR Проект</h1>
            <p>Наведите камеру на маркер MarkerVacnecov.patt</p>
            <button id="start-btn">НАЧАТЬ AR</button>
        </div>
    </div>
    
    <!-- AR сцена -->
    <div id="ar-scene-container" class="scene">
        <button id="back-btn">НАЗАД</button>
        
        <!-- Отладка видео -->
        <video id="videoDebug" autoplay playsinline></video>
        
        <!-- A-Frame сцена -->
        <a-scene 
            vr-mode-ui="enabled: false"
            embedded
            arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
            renderer="logarithmicDepthBuffer: false; precision: medium;"
        >
            <a-marker 
                type="pattern" 
                url="markers/MarkerVacnecov.patt"
                preset="custom"
                size="1"
            >
                <a-image 
                    src="images/Flag.png" 
                    position="0 0 0" 
                    scale="0.25 0.25 0.25"
                    rotation="-90 0 0"
                ></a-image>
            </a-marker>
            
            <a-entity camera></a-entity>
        </a-scene>
    </div>

    <script>
        // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
        let currentStream = null;
        
        // ========== ОСНОВНЫЕ ФУНКЦИИ ==========
        
        // 1. ЗАПРОС КАМЕРЫ (100% РАБОЧИЙ СПОСОБ)
        function startCamera() {
            return new Promise((resolve, reject) => {
                // Останавливаем предыдущий стрим если есть
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                // Параметры камеры
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' }, // Задняя камера
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                };
                
                // Запрашиваем доступ
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        currentStream = stream;
                        
                        // Для отладки - показываем видео
                        const videoDebug = document.getElementById('videoDebug');
                        videoDebug.srcObject = stream;
                        videoDebug.style.display = 'block';
                        
                        console.log('✓ Камера запущена успешно');
                        resolve(stream);
                    })
                    .catch(err => {
                        console.error('✗ Ошибка камеры:', err.name, err.message);
                        
                        // Пробуем менее строгие настройки
                        const fallbackConstraints = {
                            video: true,
                            audio: false
                        };
                        
                        navigator.mediaDevices.getUserMedia(fallbackConstraints)
                            .then(stream => {
                                currentStream = stream;
                                console.log('✓ Камера запущена с настройками по умолчанию');
                                resolve(stream);
                            })
                            .catch(fallbackErr => {
                                console.error('✗ Полная ошибка камеры:', fallbackErr);
                                alert('ОШИБКА КАМЕРЫ: ' + fallbackErr.message + '\n\n1. Разрешите доступ к камере\n2. Обновите страницу\n3. Используйте Chrome/Safari');
                                reject(fallbackErr);
                            });
                    });
            });
        }
        
        // 2. ПЕРЕКЛЮЧЕНИЕ НА AR СЦЕНУ
        async function goToAR() {
            console.log('Переключаемся на AR сцену...');
            
            try {
                // Сначала запускаем камеру
                await startCamera();
                
                // Скрываем стартовую сцену
                document.getElementById('start-scene').style.display = 'none';
                
                // Показываем AR сцену
                document.getElementById('ar-scene-container').style.display = 'block';
                
                // Даем A-Frame время на инициализацию
                setTimeout(() => {
                    const scene = document.querySelector('a-scene');
                    if (scene && scene.hasLoaded) {
                        console.log('✓ A-Frame сцена загружена');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Не удалось перейти в AR режим:', error);
            }
        }
        
        // 3. ВОЗВРАТ НА ГЛАВНЫЙ ЭКРАН
        function goBack() {
            // Останавливаем камеру
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            // Скрываем AR сцену
            document.getElementById('ar-scene-container').style.display = 'none';
            
            // Показываем стартовую сцену
            document.getElementById('start-scene').style.display = 'flex';
            
            // Скрываем отладку видео
            document.getElementById('videoDebug').style.display = 'none';
            
            console.log('Вернулись на главный экран');
        }
        
        // 4. ПРОВЕРКА ПОДДЕРЖКИ КАМЕРЫ
        function checkCameraSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('ВАШ БРАУЗЕР НЕ ПОДДЕРЖИВАЕТ КАМЕРУ!\nИспользуйте:\n• Chrome 53+\n• Safari 11+\n• Firefox 36+');
                return false;
            }
            return true;
        }
        
        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        function init() {
            console.log('=== ИНИЦИАЛИЗАЦИЯ AR ПРОЕКТА ===');
            
            // Проверяем поддержку камеры
            if (!checkCameraSupport()) {
                document.getElementById('start-btn').disabled = true;
                document.getElementById('start-btn').innerText = 'КАМЕРА НЕ ПОДДЕРЖИВАЕТСЯ';
                return;
            }
            
            // Настраиваем начальный экран
            document.getElementById('start-scene').style.display = 'flex';
            document.getElementById('ar-scene-container').style.display = 'none';
            
            // Кнопка "НАЧАТЬ AR"
            document.getElementById('start-btn').addEventListener('click', goToAR);
            
            // Кнопка "НАЗАД"
            document.getElementById('back-btn').addEventListener('click', goBack);
            
            // ESC для возврата
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') goBack();
            });
            
            // Обработка видимости страницы
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && currentStream) {
                    console.log('Страница скрыта - останавливаем камеру');
                    goBack();
                }
            });
            
            // Предотвращаем масштабирование на мобильных
            document.addEventListener('touchmove', (e) => {
                if (e.touches.length > 1) e.preventDefault();
            }, { passive: false });
            
            console.log('✓ Приложение готово к работе');
        }
        
        // ========== ЗАПУСК ПРИ ЗАГРУЗКЕ СТРАНИЦЫ ==========
        window.addEventListener('load', init);
        
        // ========== ЭКСТРЕННЫЙ СБРОС КАМЕРЫ ==========
        window.resetCamera = function() {
            console.log('=== СБРОС КАМЕРЫ ===');
            if (currentStream) {
                currentStream.getTracks().forEach(track => {
                    console.log('Останавливаем трек:', track.label);
                    track.stop();
                });
                currentStream = null;
            }
            document.getElementById('videoDebug').style.display = 'none';
        };
        
        // ========== ПРОВЕРКА ФАЙЛОВ ==========
        window.checkFiles = function() {
            console.log('=== ПРОВЕРКА ФАЙЛОВ ===');
            const files = [
                'markers/MarkerVacnecov.patt',
                'images/Flag.png'
            ];
            
            files.forEach(url => {
                fetch(url)
                    .then(response => {
                        console.log(`✓ ${url}: ${response.status} ${response.statusText}`);
                    })
                    .catch(error => {
                        console.error(`✗ ${url}: ${error.message}`);
                        alert(`ФАЙЛ НЕ НАЙДЕН: ${url}\nПоместите файл в правильную папку!`);
                    });
            });
        };
        
        // Автопроверка файлов при загрузке
        setTimeout(window.checkFiles, 1000);
    </script>
</body>
</html>